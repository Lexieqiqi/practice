define(function(require,exports,module){var model=new Model();model.extendModels({isFirstBridge:{fetchUrl:"/goform/getWizard"},wifiScan:{container:$("#pageScan"),fetchUrl:"/goform/getWizard",defaultViewData:{wifiScan:"scaning",scanTitle:_("Scanning wireless signals…")},getTransfer:function(data){if(!data.wifiScan){if(data.timeout){$("#signalWrap").find("ul").html('<li class="signal-item" style="color:#f00;">扫描超时</li>')}else{$("#signalWrap").find("ul").html("")}return{}}var listObj=data.wifiScan.sort(function(a,b){if(parseInt(a.wifiScanSignalStrength,10)>parseInt(b.wifiScanSignalStrength,10)){return -1}else{return 1}});var viewData={wifiScan:listObj,scanTitle:_("Please select the WiFi name to extend.")};return viewData}},bridge:{container:$("#pagePassword"),fetchUrl:"/goform/getWifiRelay",submitUrl:"/goform/setWifiRelay",defaultViewData:{wifiSsid:""},getTransfer:function(data){return data.connectInfo}},sysStatusInfo:{fetchUrl:"/goform/getStatus",container:"#pageScanResult",defaultViewData:{bridgeSts:{extended:"0",wifiRate:"-90"},extended:"0",wifiRate:"-90"},getTransfer:function(data){return{bridgeSts:data.sysStatusInfo}}},wifiBasic:{container:"#pageSsidName",fetchUrl:"/goform/getWifi",submitUrl:"/goform/setWifi",defaultViewData:{ssidName:""},getTransfer:function(data){data.wifiBasic.wifiPwd=(data.wifiBasic.wifiNoPwd==="true")?"":data.wifiBasic.wifiPwd;return data.wifiBasic},setTransfer:function(data){data.wifiNoPwd=($("#wirelessPwd").val()=="")?"true":"false";return data}},userList:{container:"#pageUserList",fetchUrl:"/goform/getUserList",submitUrl:"/goform/setUserList",defaultViewData:{}}});var SpecifyViewModule=ViewModule.extend({customWidget:{wifiScan:function(data){var listStr="";if(data=="scaning"){$(this).find("ul").html('<li style="text-align:center; padding:20px;"><img src="/img/loading.gif" alt="" /></li>');return}var signal;for(var i=0;i<data.length;i++){signal=parseInt(data[i].wifiScanSignalStrength,10);if(signal>=-45){signal="icon-signal-4"}else{if(signal<-45&&signal>=-60){signal="icon-signal-3"}else{if(signal<-60&&signal>=-74){signal="icon-signal-2"}else{signal="icon-signal-1"}}}listStr+=('<li class="signal-item" data-ssid-index="'+i+'"><span class="text-ellipsis signal-text">'+escapeText(data[i].wifiScanSSID)+'</span><i class="icon scan-icon icon-signal '+signal+'"></i>'+(data[i].wifiScanSecurityMode=="NONE"?"":'<i class="icon scan-icon icon-lock"></i>')+"</li>")}$(this).removeClass("transition").css3({transform:"translateY(-150%)"}).find("ul").html(listStr);var that=this;setTimeout(function(){$(that).addClass("transition").css3({transform:"none"})},10)},onlineList:function(data){var onlineListStr="";for(var i=1;i<data.length;i++){onlineListStr+=('<li class="list-item" style="height:40px;" data-ssid-index="'+i+'"><div class="text-ellipsis list-text"><div class="text-ellipsis" style="height:20px;line-height: 27px;">'+escapeText(data[i].devName)+'</div><div style="height:30px;font-size:10px;color:#8A8383;line-height: 20px;">'+data[i].devIp+'</div></div><input type="button" class="user-list-icon add-to-black" value="'+_("Defriend")+'"/></li>')}$(this).removeClass("transition").css3({transform:"translateY(-150%)"}).find("ul").eq(0).html(onlineListStr);var that=this;setTimeout(function(){$(that).addClass("transition").css3({transform:"none"})},10)},blackList:function(data){var blackListStr="";for(var j=0;j<data.length;j++){blackListStr+=('<li class="list-item" data-ssid-index="'+j+'"><span class="text-ellipsis list-text">'+escapeText(data[j].devName)+'</span><input type="button" class="user-list-icon delete-from-black" value="'+_("Delete")+'"/></li>')}$(this).removeClass("transition").css3({transform:"translateY(-150%)"}).find("ul").eq(0).html(blackListStr);var that=this;setTimeout(function(){$(that).addClass("transition").css3({transform:"none"})},10)},bridging:function(data){$(this).find(".connecting-circle").removeClass("connect-fail");if(data=="begin"){$("#bridgingTxt").html(_("Extending…"))}else{if(data=="success"){$("#bridgingTxt").html(_("The extender is in extending process. Please wait a moment."))}else{if(data=="fail"){$(this).find(".connecting-circle").addClass("connect-fail");$(this).find("#bridgingTxt").html(_("Failed to extend."))}else{if(data=="jumpFail"){$(this).find(".connecting-circle").addClass("connect-fail");$(this).find("#bridgingTxt").html(_("Successful to extend. Please use the extended WiFi name to connect to the extender."))}}}}},bridgeSts:function(data){var signal;if(data.extended=="1"){$(this).removeClass("connected disconnected").addClass("connected");$("#extended").attr("class","success-status icon-y");$("#wifiRate").html(translateSignal(data.wifiRate));if(data.wifiRate>=-45){signal="icon-signal4"}else{if(data.wifiRate<-45&&data.wifiRate>=-60){signal="icon-signal3"}else{if(data.wifiRate<-60&&data.wifiRate>=-74){signal="icon-signal2"}else{signal="icon-signal1"}}}$("#signalPic").removeClass("icon-signal2 icon-signal3 icon-signal4").addClass(signal);$("#reScanBtn2").html(_("Extend another WiFi name.")).removeClass("btn-primary").css("color","#5adc70")}else{$(this).removeClass("connected disconnected").addClass("disconnected");$("#reScanBtn2").html(_("Re-extend the WiFi name.")).removeClass("btn-primary").addClass("btn-primary");$("#extended").attr("class","error-status icon-x");$("#wifiRate").removeClass("success-status").html("0%");$("#signalPic").removeClass("icon-signal2 icon-signal3 icon-signal4")}$("#bridgeSsidName").html(escapeText(data.extendName));$("#statusOnlineNumber").html('<span class="online-num-icon">'+data.statusOnlineNumber+"</span>")}},initialize:function(){var that=this;this.ssidListScroll=new IScroll("#signalWrap");this.model.fetchData("isFirstBridge",{module1:"isFirstBridge"},function(data){var initPage="";if(!data.isFirstBridge.isFirstBridge){initPage="#pageScanResult";that.checkBridge()}else{initPage="#pageScan";that.updatewifiScan()}$(initPage).removeClass("none")})},initEvent:function(){var that=this,model=that.model,bridgeT=0;$("#reScanBtn").on(click,function(){that.updatewifiScan()});$("#bridgeSsidNameWrap").on(click,function(){that.renderForModel("wifiBasic","fetch",function(){goToPage("#pageSsidName")})});$("#ssidNamePrevBtn").on(click,function(){goToPage("#pageScanResult","left");that.reset("#pageSsidName")});$("#ssidNameSave").on("click",function(){var wifiViewData=that.model.getViewData("wifiBasic");var wifiHideSSID=$("input[name=wifiHideSSID]").attr("checked")?"true":"false";if(wifiHideSSID=="true"){that.saveForModel("wifiBasic",function(){goToPage("#pageScanResult","left")})}else{if((wifiViewData.wifiSSID==$("#wifiSSID").val())&&(wifiViewData.wifiPwd==$("#wirelessPwd").val())){that.saveForModel("wifiBasic",function(){goToPage("#pageScanResult","left")})}else{$.showConfirm(_("If you change the WiFi name or WiFi password, you need to connect to the extender with the new WiFi name or WiFi password. Are you sure to change them?"),function(){that.saveForModel("wifiBasic",function(){goToPage("#pageScanResult","left")})})}}});$("#onlineNumTxtWrap").on(click,function(){that.renderForModel("userList","fetch",function(){goToPage("#pageUserList")})});$("#listBackBtn").on(click,function(){goToPage("#pageScanResult","left")});$("#blackWrap").on(click,".delete-from-black",function(){var index=$(this).parent().attr("data-ssid-index");var mac=model.getViewData("userList").blackList[index].devMac;var subData={module1:"delFromBlackList",mac:mac};that.model.saveData("userList",subData,function(){goToPage("#pageScanResult","left")})});$("#onlineWrap").on(click,".add-to-black",function(){var index=$(this).parent().attr("data-ssid-index");var mac=model.getViewData("userList").onlineList[index].devMac;var subData={module1:"addToBlackList",mac:mac};that.model.saveData("userList",subData,function(){goToPage("#pageScanResult","left")})});$("#signalWrap").on(click,"li",function(){if(typeof $(this).data("ssid-index")=="undefined"){return}var wifiSelected=model.getViewData("wifiScan").wifiScan[parseInt($(this).data("ssid-index"))],ssid=wifiSelected.wifiScanSSID,wifiRate=wifiSelected.wifiScanSignalStrength;that.wifiRate=wifiRate;var subData={module1:"setExtenderWifi",wifiRelaySSID:ssid||"",wifiRelaySecurityMode:wifiSelected.wifiScanSecurityMode||"",wifiRelayPwd:"",wifiRelayChannel:wifiSelected.wifiScanChannel||"",module2:"setWifiInfo",wizardSSID:ssid||"",wizardSSIDPwd:""};if(wifiSelected.wifiScanSecurityMode=="UNKNOW"){$.alert(_("The security method of the uplink device is WEP, which is not supported by the extender."))}else{var bridgeData=$.extend({wifiPwd:""},wifiSelected);if(bridgeData.wifiScanSSID){bridgeData.wifiScanSSID=escapeText(bridgeData.wifiScanSSID);bridgeData.title1Show=true;bridgeData.title2Show=false;bridgeData.wifiSsidShow=false}else{bridgeData.title1Show=false;bridgeData.title2Show=true;bridgeData.wifiSsidShow=true}bridgeData.wifiPwdShow=(bridgeData.wifiScanSecurityMode!="NONE");that.renderForModel("bridge","default");model.setData("bridge",bridgeData);that.renderForModel("bridge");goToPage("#pagePassword")}});$("#keepUpper").on("click",function(){var selected=$("#keepUpper").prop("checked");if(selected){$("#extenderInfo").addClass("none")}else{$("#extenderInfo").removeClass("none");that.model.fetchData("bridge",{module1:"connectInfo"},function(data){$("#extenderSsid").val(data.extenderSsid);$("#extenderPwd").val(data.extenderPwd)})}});$("#passwordPrevBtn").on(click,function(){that.renderForModel("wifiScan","last");goToPage("#pageScan","left");$("#keepUpper").prop("checked",true);var selected=$("#keepUpper").prop("checked");if(selected){$("#extenderInfo").addClass("none")}else{$("#extenderInfo").removeClass("none")}});$("#ssidpwdFinish").on(click,function(){$("input").blur();var container=that.model._models.bridge.container;var selected=$("#keepUpper").prop("checked");var transObj=that.collect(container);var submitData={module1:"setExtenderWifi",wifiRelaySSID:transObj.wifiScanSSID||$("#wifiSsid").val(),wifiRelaySecurityMode:transObj.wifiScanSecurityMode||"",wifiRelayPwd:transObj.wifiPwd||"",wifiRelayChannel:transObj.wifiScanChannel||"",module2:"setWifiInfo",wizardSSID:selected?(transObj.wifiScanSSID||$("#wifiSsid").val()):transObj.extenderSsid,wizardSSIDPwd:selected?(transObj.wifiPwd||""):transObj.extenderPwd};if(container){var errMsg=that.validateObj.check($(container).find(".validatebox"));if(errMsg){$.alert(errMsg);return false}}model.saveData("bridge",submitData,function(){goToPage("#pageBridging");that.bridge($("#pagePassword #wifiSsid").val()||$("#wifiScanSSID").text(),that.wifiRate)})});$("#reScanBtn2").on(click,function(){goToPage("#pageScan","left");that.updatewifiScan();that.stopCheckBridge()})},updatewifiScan:function(){var that=this;this.renderForModel("wifiScan","default");this.renderForModel("wifiScan","fetch",function(){that.ssidListScroll.refresh()})},bridge:function(ssid,rate){var checkRebootT,that=this,checkBridgeT,checkBridgeGapTime=1000,checkBridgeMaxTime=27000,disconnectedTime=0,isConnect=false,ssidName=ssid,wifiRate=parseInt(rate,10);that.render({bridging:"begin"},"#pageBridging");setTimeout(function(){if(checkBridgeMaxTime<=0){if(disconnectedTime>20){that.render({bridging:"fail"},"#pageBridging");setTimeout(function(){that.model.fetchData("isFirstBridge",{module1:"isFirstBridge"},function(data){var nextPage="";if(!data.isFirstBridge.isFirstBridge){nextPage="#pageScanResult";that.checkBridge()}else{nextPage="#pageScan";that.updatewifiScan()}goToPage(nextPage)})},2000);clearTimeout(checkBridgeT);return}else{isConnect=true;that.render({bridging:"success"},"#pageBridging");setTimeout(function(){checkReboot();that.checkBridge()},5000);clearTimeout(checkBridgeT)}}$.GetSetData.getJson("/goform/getStatusBeforeBridge",function(data){if(data.extended=="1"){isConnect=true;that.render({bridging:"success"},"#pageBridging");setTimeout(function(){checkReboot();that.checkBridge()},5000);clearTimeout(checkBridgeT);return}else{disconnectedTime++}});checkBridgeMaxTime-=checkBridgeGapTime;checkBridgeT=setTimeout(arguments.callee,checkBridgeGapTime)},3000);function checkReboot(){var checkJsonpGapTime=2000,checkJsonpMaxTime=2000;checkRebootT=setInterval(function(){if(checkJsonpMaxTime<=0){if(isConnect){goToPage("#pageScanResult","right");that.render({bridgeSts:{extended:"1",wifiRate:wifiRate,extendName:ssidName,statusOnlineNumber:0}},"#pageScanResult")}clearInterval(checkRebootT);return}$.ajax({type:"get",url:"/goform/getRebootStatus",dataType:"jsonp",jsonp:"callback",jsonpCallback:"flightHandler",success:function(json){if(json.status=="success"){clearInterval(checkRebootT);that.render({bridging:"success"},"#pageBridging");setTimeout(function(){window.location.reload(true)},2000)}}});checkJsonpMaxTime-=checkJsonpGapTime},checkJsonpGapTime)}},checkBridge:function(){var that=this;clearTimeout(that.bridgeT);(function(){var callee=arguments.callee;that.renderForModel("sysStatusInfo","fetch",function(){that.bridgeT=setTimeout(callee,5000)})})()},stopCheckBridge:function(){clearTimeout(this.bridgeT)}});function translateSignal(signal){var newPer=0;if(signal==0){signal=-1}signal=Number(signal)||-100;if(signal>=0){newPer="100%"}else{if(signal>=-45){newPer=80+Math.round((45+signal)*(20/45))+"%"}else{if(signal>=-60){newPer=40+Math.round((60+signal)*(40/14))+"%"}else{if(signal>-75){newPer=1+Math.round((74+signal)*(40/13))+"%"}else{newPer="0%"}}}}return newPer}var _module=new SpecifyViewModule("body",model);module.exports=_module});